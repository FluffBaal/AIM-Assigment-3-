var e=(e,s,t)=>new Promise((r,a)=>{var n=e=>{try{c(t.next(e))}catch(s){a(s)}},l=e=>{try{c(t.throw(e))}catch(s){a(s)}},c=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,l);c((t=t.apply(e,s)).next())});import{j as s}from"./index-CvtPTGeu.js";import{b as t,d as r,u as a}from"./react-vendor-79u6xiU-.js";import{u as n,a as l}from"./api-lYTg9YvB.js";import"./axios-vendor-wEVgSxmm.js";const c=({messages:e})=>s.jsx("div",{className:"space-y-4",children:e.map((e,t)=>s.jsx("div",{className:"flex "+("user"===e.role?"justify-end":"justify-start"),children:s.jsxs("div",{className:"max-w-[80%] px-4 py-2 rounded-lg "+("user"===e.role?"bg-indigo-600 text-white":"bg-gray-100 text-gray-900"),children:[s.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),e.sources&&e.sources.length>0&&s.jsx("div",{className:"mt-2 pt-2 border-t border-gray-300",children:s.jsxs("p",{className:"text-xs opacity-75",children:["Based on ",e.sources.length," source",e.sources.length>1?"s":""]})})]})},t))}),o=({sources:e})=>s.jsx("div",{className:"space-y-3",children:e.map((e,t)=>s.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("span",{className:"text-xs font-medium text-gray-600",children:["Source ",t+1]}),s.jsxs("span",{className:"text-xs text-gray-500",children:["Page ",e.page]})]}),s.jsx("p",{className:"text-sm text-gray-700 line-clamp-3",children:e.content}),s.jsxs("div",{className:"mt-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs text-gray-500",children:"Relevance"}),s.jsxs("span",{className:"text-xs font-medium text-gray-600",children:[(100*e.relevance_score).toFixed(1),"%"]})]}),s.jsx("div",{className:"mt-1 w-full bg-gray-200 rounded-full h-1.5",children:s.jsx("div",{className:"bg-indigo-600 h-1.5 rounded-full",style:{width:100*e.relevance_score+"%"}})})]})]},e.chunk_id))}),i=({fileId:r})=>{const{apiKey:a}=n(),[i,d]=t.useState([]),[u,x]=t.useState(""),[m,h]=t.useState(!1),[g,f]=t.useState([]),[p,y]=t.useState(null),j=t.useRef(null),v=t.useRef(null),b=t.useRef("");t.useEffect(()=>{var e;null==(e=j.current)||e.scrollIntoView({behavior:"smooth"})},[i]);return s.jsxs("div",{className:"flex h-[calc(100vh-16rem)] gap-6",children:[s.jsxs("div",{className:"flex-1 flex flex-col bg-white rounded-lg shadow-sm",children:[s.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[s.jsx(c,{messages:i}),s.jsx("div",{ref:j})]}),p&&s.jsx("div",{className:"px-4 py-2 bg-red-50 border-t border-red-200",children:s.jsx("p",{className:"text-sm text-red-600",children:p})}),s.jsx("form",{onSubmit:s=>e(null,null,function*(){if(s.preventDefault(),!u.trim()||!a||m)return;const e={role:"user",content:u.trim()};d(s=>[...s,e]),x(""),y(null),h(!0),f([]);const t={role:"assistant",content:"",sources:[]};d(e=>[...e,t]),b.current="";try{v.current=l.streamChat({file_id:r,message:e.content,history:i},a,e=>{"content"===e.type?(b.current+=e.content||"",d(e=>{const s=[...e],t=s[s.length-1];return"assistant"===t.role&&(t.content=b.current),s})):"sources"===e.type?(f(e.sources||[]),d(s=>{const t=[...s],r=t[t.length-1];return"assistant"===r.role&&(r.sources=e.sources),t})):"error"===e.type&&y(e.content||"An error occurred")},e=>{y(e.message),h(!1)},()=>{h(!1)})}catch(n){y(n instanceof Error?n.message:"Failed to send message"),h(!1)}}),className:"p-4 border-t",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:u,onChange:e=>x(e.target.value),placeholder:"Ask a question about your PDF...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500",disabled:m}),m?s.jsx("button",{type:"button",onClick:()=>{v.current&&(v.current(),v.current=null,h(!1))},className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500",children:"Stop"}):s.jsx("button",{type:"submit",disabled:!u.trim()||!a,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"})]})})]}),s.jsxs("div",{className:"w-80 bg-white rounded-lg shadow-sm p-4 overflow-y-auto",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Sources"}),g.length>0?s.jsx(o,{sources:g}):s.jsx("p",{className:"text-sm text-gray-500",children:"Sources will appear here when you ask a question"})]})]})},d=()=>{const{fileId:c}=r(),o=a(),{apiKey:d}=n(),[u,x]=t.useState(""),[m,h]=t.useState(!0);return t.useEffect(()=>{if(!d)return void o("/");if(!c)return void o("/");e(null,null,function*(){try{const e=yield l.getFileStatus(c,d);x(e.filename)}catch(e){o("/")}finally{h(!1)}})},[c,d,o]),m?s.jsx("div",{className:"flex justify-center items-center h-64",children:s.jsx("div",{className:"text-lg text-gray-600",children:"Loading..."})}):s.jsxs("div",{className:"h-full",children:[s.jsxs("div",{className:"mb-6",children:[s.jsx("button",{onClick:()=>o("/"),className:"text-sm text-gray-600 hover:text-gray-900 mb-2",children:"‚Üê Back to upload"}),s.jsxs("h2",{className:"text-2xl font-bold text-gray-900",children:["Chat with: ",u]})]}),c&&s.jsx(i,{fileId:c})]})};export{d as ChatPage};
